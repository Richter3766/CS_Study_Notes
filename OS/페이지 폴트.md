# 페이지 폴트 (Page Fault)

페이징 시스템에서 메모리 관리는 페이지 테이블과 TLB를 통해 이루어집니다.  
하지만 요청된 페이지가 메모리에 없을 때, 페이지 폴트가 발생합니다.

## 스왑 공간 (Swap Space)

메모리 크기는 제한적이므로, 사용 빈도가 낮은 페이지는 디스크의 **스왑 공간**으로 이동됩니다. 이를 **Swap out**이라 합니다.  
반대로, 스왑 공간에서 메모리로 페이지를 가져오는 것을 **Swap in**이라고 합니다.  
페이지 테이블은 각 페이지의 상태와 스왑 공간에서의 위치 정보를 관리합니다.

## 페이지 폴트 핸들링

1.  **페이지 폴트 발생**:  
    CPU가 요청한 페이지가 TLB에 없고, 페이지 테이블의 해당 항목(PTE)에서 present bit가 0으로 설정되어 있으면 페이지 폴트가 발생합니다.
2.  **페이지 폴트 핸들러**:  
    운영체제가 페이지 폴트 처리를 시작합니다. 유효하지 않은 접근인지 확인하는 과정도 포함됩니다.
3.  **페이지 위치 확인**:  
    PTE를 통해 스왑 공간에서의 페이지 위치를 확인합니다.
4.  **페이지 프레임 할당**:  
    메모리에서 빈 페이지 프레임을 찾거나, 페이지 교체 알고리즘에 따라 교체할 페이지를 선택합니다.
5.  **페이지 로드 (Swap in)**:  
    디스크에서 해당 페이지를 메모리로 로드합니다. 이 동안 CPU는 다른 프로세스에 제어권을 넘깁니다.
6.  **페이지 테이블 업데이트**:  
    PTE의 present bit를 1로 설정하고, 페이지 프레임 번호 등 관련 정보를 업데이트합니다.
7.  **TLB 업데이트**:  
    TLB에 새로운 페이지 정보를 추가합니다.
8.  **Instruction 재개**:  
    페이지 폴트가 발생했던 명령을 다시 실행합니다.

### 페이지 교체 (Page Replacement)

메모리가 가득 찰 경우, 페이지 교체 알고리즘을 사용하여 어떤 페이지를 스왑 아웃할지 결정합니다.

- **LW (Low Watermark), HW (High Watermark)**:  
  메모리 관리를 위한 지표입니다.  
  LW 이하로 사용 가능한 페이지가 줄면 페이지 교체를 시작하고, HW 이상으로 확보될 때까지 계속합니다.
- **클러스터링**:  
  여러 페이지를 묶어 한 번에 스왑 아웃하여 I/O 효율을 높입니다.
- **Dirty Bit**:  
  페이지가 수정되었는지 여부를 나타내는 비트입니다. 수정되지 않은 페이지만 스왑 아웃하여 I/O를 줄입니다.

## 페이지 교체 정책 (Page Replacement Policy)

- **FIFO (First-In, First-Out)**:  
  가장 먼저 메모리에 들어온 페이지를 교체합니다.  
  구현이 간단하지만, 페이지의 실제 사용 빈도를 고려하지 않기 때문에 성능이 좋지 않을 수 있습니다.
- **LRU (Least Recently Used)**:  
  가장 오랫동안 사용되지 않은 페이지를 교체합니다.  
  페이지의 사용 이력을 기반으로 교체하므로 성능이 좋지만, 구현 비용이 높습니다.
- **Approximate LRU**:  
  비용이 비싼 LRU를 근사하는 알고리즘입니다.  
  **Clock Algorithm**이 대표적입니다.  
  **과정:**
  - 각 페이지마다 reference bit를 두고, 페이지가 사용될 때마다 reference bit를 1로 설정합니다.
  - 페이지 교체가 필요할 때, reference bit가 0인 페이지를 찾아서 교체합니다.
  - reference bit가 1인 페이지는 0으로 바꾸고 다음 페이지를 검사합니다.

## Thrashing

**Thrashing**은 프로세스가 필요로 하는 페이지들을 물리 메모리가 모두 수용하지 못할 때 발생합니다.  
이 상황에서 프로세스는 끊임없이 페이지를 스왑 인/아웃하면서 극심한 페이지 폴트를 경험하게 되며, CPU는 페이지 교체에 과도한 시간을 소모하게 됩니다.  
결과적으로 CPU 활용률이 현저히 떨어지고 시스템 전체의 성능 저하를 초래할 수 있습니다.

**해결책**

- **페이지 폴트 빈도 (PFF, Page Fault Frequency) 모니터링**:  
  페이지 폴트 빈도를 모니터링하여 thrashing 발생 여부를 판단하고, 필요한 경우 프로세스에 더 많은 메모리를 할당하거나 일부 프로세스를 일시 중단합니다.
- **메모리 증설**:  
  물리 메모리 용량을 늘려 working set을 수용할 수 있도록 합니다.
- **프로세스 수 조절**:  
  동시에 실행되는 프로세스 수를 줄여 각 프로세스에 더 많은 메모리를 할당합니다.
